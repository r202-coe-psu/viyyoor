{% extends '/organizations/view.html' %}
{% import '/base/html-renderer.html' as renderer %}
{% import '/base/organization-renderer.html' as org_renderer %}

{% block title %}{{ organization.name }}{% endblock %}

{% block breadcrumbs %}
	{{ super() }}
	{% if 'admin' in request.path %}
		{% if request.endpoint == 'admin.organizations.view_users' %}
		<div class="active section">Users</div>
		{% else %}
		<a href="{{ url_for('admin.organizations.view_users', organization_id=organization.id) }}" class="section">{{ organization.name }}</a>
		<i class="right angle icon divider"></i>
		{% endif %}
	{% else %}
		{% if request.endpoint == 'organizations.view_users' %}
		<div class="active section">Users</div>
		{% else %}
		<a href="{{ url_for('organizations.view_users', organization_id=organization.id) }}" class="section">Users</a>
		<i class="right angle icon divider"></i>
		{% endif %}
	{% endif %}
{% endblock %}


{% block content %}
{{ org_renderer.render_organization_dashboard_menu_bar(organization) }}

<h2 class="ui header">
	Users
</h2>
<div class="ui divider"></div>

{% if current_user.is_admin_current_organization() %}
	{% if role == "deactivated" %}
		<a 	class="ui tertiary grey large right floated active button"
			href="{{ url_for('organizations.view_users', organization_id=organization.id, role='all') }}">
			<i class="user slash icon"></i>View Disactive members
		</a>
	{% else %}
		<a 	class="ui tertiary grey large right floated button"
			href="{{ url_for('organizations.view_users', organization_id=organization.id, role='deactivated', status='disactive') }}">
			<i class="user slash icon"></i>View Disactive members
		</a>
	{% endif %}
	<a 	class="ui tertiary blue large right floated button" onclick="$('.ui.add-member').transition('fade down')">
	<i class="user plus icon"></i>Add members
	</a>
{% endif %}


<div class="ui secondary  menu" style="width:fit-content">
	<a class="{{ 'active' if role == 'all' or not role }} item" href="{{ url_for('organizations.view_users', organization_id=organization.id, role='all') }}">
		All
	</a>
	<a class="{{ 'active' if role == 'staff' }} item" href="{{ url_for('organizations.view_users', organization_id=organization.id, role='staff') }}">
		Staff
	</a>
	<a class="{{ 'active' if role == 'admin' }} item" href="{{ url_for('organizations.view_users', organization_id=organization.id, role='admin') }}">
		Admin
	</a>
	<a class="{{ 'active' if role == 'endorser' }} item" href="{{ url_for('organizations.view_users', organization_id=organization.id, role='endorser') }}">
		Endorser
	</a>
</div>

<div class="ui add-member padded segment" style="display: none;">
	<form method="POST" class="ui form" action="{{ url_for('organizations.submit_add_members', organization_id=organization.id) }}">
		<div class="ui grid">
			<div class="thirteen wide column">
				{{ add_member_form.csrf_token() }}
				{{ renderer.render_multiple_select(add_member_form.members) }}
			</div>
			<div class="three wide column">
				<br>
				<button type="submit" class="ui primary button">
					Add
				</button>
				<a onclick="$('.ui.add-member').transition('fade down')" class="ui button">
					Cancel
				</a>
			</div>
		</div>
	</form>
</div>


<table class="ui compact celled single line table">
	<thead>
			<tr>
				<th class="one wide"></th>
				<th>Name</th>
				<th>Role</th>
				<th>Added by</th>
				{% if current_user.is_admin_current_organization() %}
				<th>Actions</th>
				{% endif %}
			</tr>
		</thead>
		<tbody>
			{% set index = namespace(value=0) %}
			{% for org_user_role in organization_user_roles %}
			<tr class="top aligned">
				{% set index.value = index.value + 1 %}
				<td>{{ index.value }}</td>
				<td class="left aligned collapsing">{{ org_user_role.user.get_fullname() }}</td>
				<td>
					<div class="ui grid">
						<div class="two wide column">
							{{ org_user_role.get_role_display() }}
						</div>
						{% if current_user.is_admin_current_organization() %}
						<div class="one wide column">
							<a style="cursor: pointer;" data-content="change role" onclick="showRoleSelectionForm('{{ org_user_role.user.id }}')">
								<i class="sync blue icon"></i>
							</a>
						</div>
						{% endif %}
					</div>
				</td>
				<td>{{ org_user_role.added_by.get_fullname() }}</td>
				{% if current_user.is_admin_current_organization() %}
					<td class="right aligned collapsing">
						{% if role == 'deactivated' %}
						<a class="ui link pop green icon circular button" data-content="activate"
						href="{{ url_for('organizations.manage_user', organization_id=organization.id, organization_user_id=org_user_role.id, operator='activate') }}">
						<i class="check icon"></i>
						</a>
						{% else %}
						<a class="ui link pop red icon circular button" data-content="deactivate"
						href="{{ url_for('organizations.manage_user', organization_id=organization.id, organization_user_id=org_user_role.id, operator='deactivate') }}">
						<i class="ban icon"></i>
						</a>
						{% endif %}
						
						<a class="ui primary icon circular link pop button" data-content="change role" onclick="showRoleSelectionForm('{{ org_user_role.user.id }}')">
							<i class="user icon"></i>
						</a>
						<div id="{{org_user_role.user.id}}" class="ui mini modal {{ org_user_role.user.id }}" >
							<div class="header">
								<span class="ui blue text">
									{{ org_user_role.user.get_fullname() }}
								</span>
								role change
							</div>
							<div class="content">
								<form method="post" class="ui form" action="{{ url_for('organizations.view_users', organization_id=organization.id, user_role_id=org_user_role.id, role=role) }}">
									<div class="ui grid">
										<div class="seven wide column">
											{{ org_user_forms[org_user_role.id].csrf_token() }}
											{{ renderer.render_select(org_user_forms[org_user_role.id].role) }}
										</div>
										<div class="nine wide column">
											<button class="ui primary button" type="submit">Save</button>
											<a class="ui button" onclick="$('.ui.mini.modal.'+'{{ org_user_role.user.id }}').modal('hide')">Cancel</a>
										</div>
								</div>
								</form>
							</div>
						</div>
					</td>
				{% endif %}
			</tr>
			{% endfor %}
		</tbody>
	</table>
{% endblock %}

{% block additional_js %}
<script>
	function showRoleSelectionForm(id) {
		$('.ui.mini.modal.'+id).modal('show')
	}
	$('.link.pop').popup({
		delay: {
			show: 200,
			hide: 70,
	  }})
</script>
{% endblock %}